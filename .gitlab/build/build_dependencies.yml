---
stages:
    - build-base

include:
    - local: .gitlab/common.yml

build-dependencies:
    extends: .docker_base_build_script
    stage: build-base
    variables:
        PROJECT: "datafed"
        COMPONENT: "dependencies"
        GIT_STRATEGY: clone
        DOCKER_FILE_PATH: "docker/Dockerfile.dependencies"
        DATAFED_HARBOR_REGISTRY: "$REGISTRY" # needed by c_harbor_artifact_count
        BUILD_INTERMEDIATE: "FALSE"
    tags:
        - docker

retag-image:
    extends: .docker_retag_image
    stage: build-base
    variables:
        PROJECT: "datafed"
        COMPONENT: "dependencies"
        GIT_STRATEGY: clone
        DATAFED_HARBOR_REGISTRY: "$REGISTRY" # needed by c_harbor_artifact_count
        BUILD_INTERMEDIATE: "FALSE"
    tags:
        - docker
    rules:
        - changes:
              - docker/**/*
              - scripts/**/*
              - core/**/*
              - common/**/*
              - CMakeLists.txt
              - cmake/**/*
              - .gitlab-ci.yml
          when: never
        - when: on_success
