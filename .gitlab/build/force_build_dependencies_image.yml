---
stages:
  - build

build-dependencies:
  stage: build
  tags:
    - ci-datafed-core
    - docker
  script:
    - |
      # Variables you need set in CI/CD Settings or here
      DOWNSTREAM_SHA=$(git submodule status ./external/DataFedDependencies/ | awk '{print $1}')   # Commit SHA to trigger on
      # Remove leading '-' if one exists
      DOWNSTREAM_SHA=${DOWNSTREAM_SHA#-}
      echo "DataFedDependencies current commit: $DOWNSTREAM_SHA"
      # Trigger the downstream pipeline
      echo "Triggering downstream pipeline... $CI_API_V4_URL/projects/$DATAFED_DEPENDENCIES_GITLAB_PROJECT_ID/trigger/pipeline"
      PIPELINE=$(curl --silent --fail --show-error -X POST \
              -F "token=$CI_JOB_TOKEN" \
              -F "ref=main" \
              --form "variables[COMMIT_SHA]=$DOWNSTREAM_SHA" \
              "$CI_API_V4_URL/projects/$DATAFED_DEPENDENCIES_GITLAB_PROJECT_ID/trigger/pipeline" )
      PIPELINE_ID=$(echo "$PIPELINE" | jq -r '.id')
      if [ "$PIPELINE_ID" = "null" ] || [ -z "$PIPELINE_ID" ]; then
          echo "❌ Failed to create pipeline"
        echo "$PIPELINE"
        exit 1
      fi
      echo "✅ Triggered pipeline $PIPELINE_ID for commit $DOWNSTREAM_SHA"
