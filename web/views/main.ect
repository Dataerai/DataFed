<!DOCTYPE html>
<html>
    <head>
        <% include 'head.ect' %>
        <link href="/fancytree/skin-themeroller/ui.fancytree.min.css" rel="stylesheet">
        <script src="/fancytree/jquery.fancytree-all.min.js"></script>
        <script type="text/javascript">
            loadUser();
            if ( !g_user || !g_user.active )
                window.location.replace("/ui");
        </script>
        <title>SDMS Main</title>
    </head>
    <body>
    <div class="col-flex" style="height:100%">
        <div class="header" style="flex:none">
            <div class="row-flex">
                <div style="flex:1;font-size: 2em">Scientific Data Management System</div><div style="flex:none;display:flex;justify-content:flex-end"><button class="btn" onclick="logout()">Log Out</button></div>
            </div>
        </div>
        <div id="content" class="content" style="flex:1 1 100%">
            <div id="tabs">
                <ul>
                    <li><a href="#tab-1">Data</a></li>
                    <li><a href="#tab-2">Projects</a></li>
                    <li><a href="#tab-3">Settings</a></li>
                </ul>
                <div id="tab-1">
                    <div class="col-flex" style="padding:0;height:100%;box-sizing: border-box;">
                        <div class="row-flex" style="flex:1 1 100%">
                            <div class="col-flex" style="flex:1 1 40%;padding:.25em">
                                <div style="flex:none">Collections &amp Data:</div>
                                <div class="ui-widget-content text" style="flex:1 1 100%;overflow:auto">
                                    <div id="data_tree" class="no-border"></div>
                                </div>
                            </div>
                            <div class="col-flex" style="flex:1 1 60%;padding:.25em">
                                <div style="flex:none">Selection Details:</div>
                                <div id="data_info" class="ui-widget-content text" style="flex:1 1 100%"></div>
                            </div>
                        </div>
                        <div style="flex:none;padding:.25em">
                            <button class="btn" onclick="dlgNewEdit(0)">New Data</button>
                            <button class="btn" onclick="dlgNewEdit(1)">New Coll.</button>
                            <button class="btn act-folder act-data" onclick="editSelected()" disabled>Edit</button>
                            <button class="btn act-folder act-data" onclick="deleteSelected()" disabled>Delete</button>
                            <button class="btn act-folder act-data" disabled>Share</button>
                            <button class="btn act-data" disabled>Link</button>
                            <button class="btn act-data" disabled>Unlink</button>
                            <button class="btn act-data" disabled>Upload</button>
                            <button class="btn act-data" disabled>Download</button>
                        </div>
                    </div>
                </div>
                <div id="tab-2">
                </div>
                <div id="tab-3">
                </div>
            </div>
        </div>
        <div class="footer" style="flex:none">
            User: <span id=uname></span>
        </div>
    </div>
    <div id='dlg_new' style='display:none'>
        <table style='width:100%'>
        <tr><td>Title:</td><td><input type='text' id='title' style='width:100%'></input></td></tr>
        <tr><td>Alias:</td><td><input type='text' id='alias' style='width:100%'></input></td></tr>
        <tr><td >Description:</td><td><textarea id='desc' rows=3 style='width:100%'></textarea></td></tr>
        <tr id='dlg_md_row'><td>Metadata:</td><td><textarea id='md' rows=3 style='width:100%'></textarea></td></tr>
        <tr id='dlg_md_row2'><td>Metadata mode:</td><td>
            <input type="radio" id="md_merge" name="md_mode" value="merge" checked>
            <label for="md_merge">Merge</label>
            <input type="radio" id="md_set"  name="md_mode" value="set">
            <label for="md_mode">Set</label>
            </td></tr>
        <tr id='dlg_coll_row'><td>Collection ID:</td><td><input type='text' id='coll' style='width:100%'></input></td></tr>
        </table>
    </div>
    <div id='dlg_alert' style='display:none'></div>
    </body>
    <script>
        function resizeHandler() {
            console.log("resized!");
            $('#tabs').tabs().height(50);
            $('#tabs').tabs().height($("#content").height()-9);
            $("#tabs").tabs("refresh");
        }

        function updateBtnState( state ){
            if ( state == undefined ) {
                console.log("undef");
                $(".btn.act-folder").button("option", "disabled", true);
                $(".btn.act-data").button("option", "disabled", true);
            } else if ( state == false ) {
                console.log("false");
                $(".btn.act-data").not(".act-folder").button("option", "disabled", true);
                $(".btn.act-folder").button("option", "disabled", false);
            } else {
                console.log("true");
                $(".btn.act-folder").button("option", "disabled", false);
                $(".btn.act-data").button("option", "disabled", false);
            }
        }

        function showSelectedInfo( key ){
            if ( key[0] == "c" ) {
                updateBtnState( false );
                viewColl( key, function( data ){
                    var item = data.data[0];
                    var html = "<table class='info_table'><col width='30%'><col width='70%'>";
                    html += "<tr><td>Type:</td><td>Data Collection</td></tr>";
                    html += "<tr><td>ID:</td><td>" + item.id + "</td></tr>";
                    html += "<tr><td>Title:</td><td>" + item.title + "</td></tr>";
                    html += "<tr><td>Alias:</td><td>" + (item.alias?item.alias:"(none)") + "</td></tr>";
                    html += "<tr><td>Desc:</td><td>" + (item.desc?item.desc:"(none)") + "</td></tr>";
                    html += "<tr><td>Owner:</td><td>" + (item.owner?item.owner:"n/a") + "</td></tr>";
                    html += "</table>";
                    $("#data_info").html(html);
                }); 
            } else if ( key[0] == "d" ) {
                updateBtnState( true );
                viewData( key, function( data ){
                    var item = data.data[0];
                    var html = "<table class='info_table'><col width='30%'><col width='70%'>";
                    html += "<tr><td>Type:</td><td>Data Record</td></tr>";
                    html += "<tr><td>ID:</td><td>" + item.id + "</td></tr>";
                    html += "<tr><td>Title:</td><td>" + item.title + "</td></tr>";
                    html += "<tr><td>Alias:</td><td>" + (item.alias?item.alias:"(none)") + "</td></tr>";
                    html += "<tr><td>Desc:</td><td>" + (item.desc?item.desc:"(none)") + "</td></tr>";
                    html += "<tr><td>Data Size (bytes):</td><td>" + (item.dataSize?item.dataSize:"n/a") + "</td></tr>";
                    html += "<tr><td>Data Updated:</td><td>" + (item.dataTime?Date(item.dataTime*1000).toString():"n/a") + "</td></tr>";
                    html += "<tr><td>Metadata:</td><td>" + (item.metadata?item.metadata:"(none)") + "</td></tr>";
                    html += "<tr><td>Record Updated:</td><td>" + (item.recTime?Date(item.recTime*1000).toString():"n/a") + "</td></tr>";
                    html += "<tr><td>Owner:</td><td>" + (item.owner?item.owner:"n/a") + "</td></tr>";
                    html += "</table>";
                    $("#data_info").html(html);
                }); 
            } else {
                updateBtnState();
                $("#data_info").html("");
            }
        }

        window.addEventListener( "resize", resizeHandler );

        document.getElementById("uname").innerHTML = g_user.name;

        $("#tabs").tabs({heightStyle:"fill"}).css({
            'min-height': '50px',
            'overflow': 'auto'
        });

        $(".btn").button();

        var tree_source = [{title:"root",folder:true,lazy:true,key:"root"},
            {title:"Loose data",folder:true,lazy:true,key:"loose"}];

        $("#data_tree").fancytree({
            extensions: ["themeroller"],
            themeroller: {
                activeClass: "ui-state-hover",
                addClass: "",
                focusClass: "",
                hoverClass: "ui-state-active",
                selectedClass: ""
            },
            source: tree_source,
            selectMode: 1,
            lazyLoad: function( event, data ) {
                if ( data.node.key == "loose" ) {
                    data.result = {
                        url: "/api/dat/list",
                        cache: false
                    };
                } else {
                    data.result = {
                        url: "/api/col/read?id=" + data.node.key,
                        cache: false
                    };
                }
            },
            postProcess: function( event, data ) {
                console.log( "pos proc:", data );
                if ( data.node.parent ) {
                    data.result = [];
                    var item;
                    var alias;
                    var folder;
                    var entry;
                    for ( var i in data.response.data ) {
                        item = data.response.data[i];
                        alias = item.alias?item.alias.substr(item.alias.indexOf(":") + 1):"";
                        is_folder = item.id[0]=="c"?true:false;
                        entry = { title: "<span style='display:inline-block;width:20ch'>" + item.id.substr(2) + (alias?" (" + alias + ")":" ") + "</span> \"" + item.title + "\"", folder: is_folder, key: item.id };
                        if ( is_folder )
                            entry.lazy = true;
                        data.result.push( entry );
                    }
                }
            },
            activate: function( event, data ) {
                console.log("click",data.node );
                //data.node.setSelected(true);
                showSelectedInfo( data.node.key );
            },
            select: function(event, data){
                console.log("select",data.node.isSelected(),data.node.data);
            }
        });

    </script>
</html>
